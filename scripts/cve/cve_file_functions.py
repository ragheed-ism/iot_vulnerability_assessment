import pandas as pd


def clean_input_data(df: pd.DataFrame):
    # Split the fist column of the dataframe into two columns representing
    # the cwe and the weaknes it is related to.
    df["cwe-iot"] = df.iloc[:, 0].apply(
        lambda x: "-".join(x.split("-")[0:2]).split(":")[0]
    )
    df["weakness"] = df.iloc[:, 0].apply(lambda x: x.split("-")[-1])
    df.drop(df.columns[0], axis=1, inplace=True)

    # Clean the category names from any trailing spaces.
    df.columns = df.columns.str.strip()

    return df


def clean_cwe_dataframe(df_cwe: pd.DataFrame):
    # Clean the input data
    df_cwe = clean_input_data(df_cwe)

    # Get the categories found in the dataframe and put them in a list
    iot_categories = df_cwe.columns.tolist()
    iot_categories.remove("cwe-iot")
    iot_categories.remove("weakness")
    iot_categories.sort()

    # Generate an id for every category and pu them in a dictionary & dataframe
    category_index = {k: v for v, k in enumerate(iot_categories)}
    df_category_index = pd.DataFrame(category_index.items(), columns=["category", "id"])

    # Create an empty dataframe to be filled
    df_cwe_final = pd.DataFrame()
    # Itterate over every category found in the dataframe
    for cat in iot_categories:
        # Create an empty dataframe for every category to be filled
        df_tmp = pd.DataFrame()

        # Get columns related to the category
        df_tmp = (
            df_cwe.loc[:, ["cwe-iot", "weakness", cat]]
            .dropna(how="any")
            .rename(columns={cat: "CVE"})
        )

        # Map the category to its id
        df_tmp["category_id"] = category_index[cat]

        # Split the CVE list into different rows
        df_tmp["CVE"] = df_tmp["CVE"].str.split(",")
        df_tmp = df_tmp.explode("CVE").reset_index(drop=True)
        df_tmp["CVE"] = df_tmp["CVE"].str.strip()

        # Concat the temporary dataframe to the final dataframe
        df_cwe_final = pd.concat([df_cwe_final, df_tmp])

    return df_category_index, df_cwe_final
